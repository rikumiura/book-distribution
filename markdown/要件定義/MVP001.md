# MVP-0 要求定義書  
## 出版社 納品スパイク（メタデータ＋PDF納品）

---

## 1. 目的

本MVP-0では、出版社が書籍のメタデータおよび書籍本体ファイル（PDF）を納品でき、  
その納品物を自社側で確認・参照できる状態を作ることを目的とする。

本MVPはアジャイル開発における最小の検証単位であり、  
後続の配信・許諾・売上・精算機能の前提となる「納品」という行為を成立させることに集中する。

---

## 2. スコープ

### 2.1 実装対象（含めるもの）

#### 書籍メタデータ登録
- 書籍を識別する最小限のメタデータを登録できる

#### 書籍本体ファイル登録
- 書籍本体ファイル（PDF）をアップロードできる
- 1書籍につきファイルは1つ（差し替え不可）

#### 納品確認（自社視点）
- 納品された書籍の一覧・詳細を取得できる
- アップロード済みPDFをダウンロードできる

---

### 2.2 実装対象外（含めないもの）

- ログイン／認証機能
- ユーザー／アカウント管理
- 出版社の複数社管理（出版社は1社固定でよい）
- 書店の概念
- 配信許諾管理
- 配信処理（SFTP／疑似配信）
- 売上報告
- 精算処理
- メール通知
- アダルトレベル
- サムネイル管理
- 配信日／先行販売
- ファイル差し替え／バージョン管理（v1固定）

---

## 3. 用語

- **書籍**：ISBNで一意に識別される納品単位（MVP0では改訂・差し替えを扱わない）
- **書籍本体ファイル**：書籍に紐づくPDFファイル
- **納品**：書籍メタデータ登録と書籍本体ファイル登録が完了した状態

---

## 4. データ要件

### 4.1 書籍メタデータ項目
- `bookId`：UUIDv7（サーバ生成）
- `isbn`：必須・一意
- `title`：必須
- `price`：任意（円）

### 4.2 入力制約
#### ISBN
- 10桁または13桁のみ許可
- 入力時はハイフン有無を許容する
- 保存時は **ハイフンを除去して正規化** して保持する（重複判定も正規化後で行う）

#### タイトル
- 1〜200文字

#### 価格（任意）
- 0以上の整数（円）
- 未指定は `null` として扱ってよい（MVP0では精算を扱わないため）

---

## 5. ファイル要件（PDF）

### 5.1 形式と検証
- アップロード可能形式は **PDFのみ**
- サーバは以下の最低限の検証を行う
  - 拡張子が `.pdf`（任意）
  - 先頭が `%PDF` であること（マジックナンバー）
  - `Content-Type: application/pdf` は参考とする（絶対条件にしない）

### 5.2 サイズ上限
- 最大 50MB（暫定）

### 5.3 書籍との関係
- 1書籍につきファイル1つ
- 既にファイルが登録済みの書籍に対する再アップロードは拒否する（差し替え不可）

### 5.4 保存方式
- ローカルボリュームに保存する（Devcontainerマウント想定）
- ファイル名は内部IDベースとし、ISBNをファイル名に使用しない
- ファイル参照は保存パスを返さず、ダウンロードAPIで提供する

---

## 6. 状態（ステータス）

MVP0では書籍の状態を以下の2状態とする。

- `METADATA_ONLY`：メタデータ登録済み・ファイル未登録
- `DELIVERED`：ファイル登録済み（＝納品完了）

---

## 7. API仕様（最小）

### 7.1 書籍メタデータ登録
- **POST** `/books`

Request (JSON):
- `isbn`: string
- `title`: string
- `price?`: number

Response (201):
- `bookId`: string (UUIDv7)
- `isbn`: string（正規化後）
- `title`: string
- `price`: number | null
- `status`: "METADATA_ONLY"
- `createdAt`: string (ISO8601)

失敗:
- 400: 入力不正（ISBN形式、タイトル空、価格不正など）
- 409: ISBN重複

---

### 7.2 書籍一覧取得
- **GET** `/books`

Response (200):
- 書籍配列（`bookId`, `isbn`, `title`, `price`, `status`, `createdAt`）

---

### 7.3 書籍詳細取得
- **GET** `/books/{bookId}`

Response (200):
- `bookId`, `isbn`, `title`, `price`, `status`, `createdAt`
- `file?`: ファイル情報（存在する場合）
  - `sizeBytes`
  - `sha256`（任意）
  - `uploadedAt`

失敗:
- 404: 存在しない

---

### 7.4 書籍本体ファイル登録（アップロード）
- **POST** `/books/{bookId}/file`
- `multipart/form-data`（フィールド名：`file`）

Response (200):
- `bookId`
- `status`: "DELIVERED"
- `file`: `sizeBytes`, `uploadedAt`

失敗:
- 404: 書籍が存在しない
- 400: PDFでない／破損など
- 409: 既にファイル登録済み
- 413: サイズ超過
- 500: 想定外

---

### 7.5 書籍本体ファイル取得（ダウンロード）
- **GET** `/books/{bookId}/file`

Response (200):
- PDFバイナリ（Content-Type: application/pdf）

失敗:
- 404: 書籍が存在しない、またはファイル未登録

---

## 8. エラー仕様（共通）

### 8.1 HTTPステータス
- 400: 入力不正
- 404: 存在しない
- 409: 競合（ISBN重複、ファイル既登録）
- 413: サイズ超過
- 500: 想定外

### 8.2 エラーレスポンス形式（JSON）
- `code`: string（例：`ISBN_DUPLICATE`, `INVALID_ISBN`, `FILE_ALREADY_EXISTS`）
- `message`: string（人間向け）
- `details?`: object（任意）

---

## 9. 同時実行・冪等性

- 書籍登録は ISBN 正規化後の一意制約により二重登録を防ぐ
- ファイルアップロードは同時実行を考慮し、
  片方のみ成功、もう片方は 409 で拒否されること

---

## 10. ログ・監査（最低限）

- 書籍作成・ファイル登録はアプリケーションログに記録する
- データとして以下の時刻を保持する
  - `createdAt`
  - `uploadedAt`（ファイル登録時）

---

## 11. 完了条件（Done）

以下をすべて満たした時点で、本MVP-0は完了とする。

1. `POST /books` でメタデータを登録できる
2. 同一ISBN（正規化後）の登録は409で拒否される
3. `POST /books/{id}/file` でPDFをアップロードできる
4. `GET /books` で一覧を取得できる
5. `GET /books/{id}` で詳細（ファイル情報含む）を取得できる
6. `GET /books/{id}/file` でPDFをダウンロードできる
7. ステータスが `METADATA_ONLY → DELIVERED` に遷移することが確認できる
