# B2B 書籍ファイル流通システム 要求定義書

## 1. 目的

本システムは、出版社から納品されたデジタル書籍（EPUB/PDF）を自社が審査・管理し、書店へ配信するB2B向け書籍ファイル流通システムである。

書店から日次で報告される売上（販売冊数）をもとに、月次で三者配分（出版社・自社・書店）に基づく精算を行い、出版社へ書籍別内訳付きで通知することを目的とする。

本システムは技術習得を目的とした練習用プロジェクトであるが、業務システムとして破綻しない要求定義を行う。

---

## 2. 登場組織・利用者

### 組織
- 出版社（複数社）
- 書店（複数社）
- 自社（システム管理主体）

### ユーザー
- すべてのユーザーは ID / パスワードで認証する
- 出版社および書店の組織・ユーザーは、自社管理者が登録・承認したもののみが利用できる。
- 出版社・書店による自己登録機能は提供しない。

---

## 3. 用語定義

### 書籍（作品）
ISBNで一意に識別される配信単位。改訂や差し替えは「書籍本体ファイルのバージョン」で表現する。異なるISBNは別書籍として扱う。

### 書籍本体ファイル
書店に配信されるEPUBまたはPDFファイル。

### ファイル形式
書籍本体ファイルの形式。EPUB または PDF。

### バージョン
書籍本体ファイルの版。校正や修正によりファイルが更新された場合に増加する。旧バージョンは配信対象外とするが、履歴として保持する。

### 配信許諾
出版社が、特定の書店に対して当該書籍の配信・販売を許可すること。

### 受領可能条件
書店が受領できる書籍の条件。
以下を含む。
- 許容アダルトレベル上限
- 対応可能なファイル形式（EPUB / PDF）

### 配信
書籍本体ファイルを、書店のSFTPサーバへ送信すること。

### 売上報告
書店が日次で、自社へ売上実績を報告すること。
報告内容は ISBN ごとの販売冊数とする。

### 修正報告
月次締め前の売上報告に誤りがあった場合に行う修正報告。

### 月次締め
対象月の売上を確定する処理。
月次締め後は、当該月の修正報告を受け付けない。

### 精算
月次締めされた売上をもとに、
三者配分（出版社・自社・書店）に従って金額を算出すること。

### 三者配分（料率）
売上を出版社・自社・書店に配分する割合。
責任主体は自社とする。

---

## 4. アダルトレベル定義（暫定）

アダルトレベルは強度の序列として扱う。

| Lv   | 定義                                   |
| ---- | -------------------------------------- |
| 1    | 全年齢・性的表現なし                   |
| 2    | 軽微な恋愛描写（キス・抱擁）           |
| 3    | 性的含意のある表現（暗転・示唆）       |
| 4    | 性的含意が明確な描写（接触・音・比喩） |
| 5    | 性交を間接的に連想させる描写           |
| 6    | 性交前後の描写（行為自体は描かれない） |
| 7    | 性交の直接的描写（露骨ではない）       |
| 8    | 性交の明確な描写（局所的）             |
| 9    | 性行為が作品の主要要素                 |
| 10   | R18（明確な成人向け）                  |

---

## 5. 書籍登録（出版社）

- 出版社は書籍メタデータ（ISBN一意、価格、タイトル等）を登録できる
- 書籍本体ファイルとして EPUB / PDF を登録できる
- 本体ファイルは差し替え可能とし、バージョンを管理する
- サムネイルは任意とする
  - 未登録時はデフォルト画像を表示する
- 登録処理は部分成功を許可しない

---

## 6. 自社による審査・設定

- 自社は書籍に対してアダルトレベルを設定する
- 自社は書店ごとに受領可能条件を設定する
  - アダルトレベル上限
  - 対応可能ファイル形式
- 自社は書籍ごとに配信許諾（書籍×書店）を管理する
- 配信対象は以下をすべて満たす書店とする
  1. 配信許諾が存在する
  2. 書店の受領可能条件を満たしている

---

## 7. 配信要件（SFTP）

- 配信はSFTPにより行う
- 配信日は到来しているが、未配信の書店が存在する場合、自動で配信を行う
- 配信は最大3回まで再試行する
- 配信ログを保持する（書籍・バージョン・書店・結果）

### 配信完了条件
以下をすべて満たした場合、配信完了とする。
1. SFTP転送がエラーなく完了している
2. 転送対象ファイルのサイズが送信元と一致している
3. 配信ステータスが「成功」に更新されている

上記のいずれかを満たさない場合、配信は失敗とする。
転送完了後にステータス更新に失敗した場合は「要確認」として扱う。

---

## 8. 売上報告（書店）

- 書店は日次で売上報告を行う
- 報告内容は ISBN ごとの販売冊数のみとする
- `store_id + report_date` は一意とする
- 同一キーでの再送は拒否する
- 修正は修正報告として別途受け付ける

---

## 9. 月次締め・精算

- 月次で締め処理を実行する
- 未提出の売上報告が存在する場合、締め処理はエラーで停止する
- 月次締め後は修正報告を受け付けない
- 精算は三者配分に従い、出版社・自社・書店の金額を算出する
- 精算結果は書籍別内訳を含める

---

## 10. 通知要件

- 月次精算完了後、出版社へメール通知を行う
- メールには書籍別内訳を含める
- メール送信失敗時はリトライを行う
- リトライ後も失敗した場合、送信失敗として追跡可能とする

---

## 11. 将来対応として想定している事項

- 料率の期間指定変更
- 返金・返品対応
- アダルト基準の変更
- 書籍ファイルの再配信
- 書店の受領可能条件変更
- 期間限定キャンペーン機能（提案・登録）

※ 上記は本要求定義の実装対象外とするが、将来的に拡張される可能性がある。